<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧农业平台 - 产品中心</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --farm-green: #7CB342;
            --dark-green: #1B5E20;
            --accent-color: #FF9800;
            --accent-light: #FFB74D;
            --harvest-orange: #FF8F00;
            --water-blue: #29B6F6;
            --gold-color: #FFD700;
            --silver-color: #C0C0C0;
            --bronze-color: #CD7F32;
            --background-color: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            --card-background: #ffffff;
            --border-color: rgba(124, 179, 66, 0.25);
            --text-color: #333;
            --light-bg: linear-gradient(135deg, #f8fdf8, #f1f8e9);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 25px;
            --shadow-sm: 0 2px 5px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 6px 16px rgba(0,0,0,0.12);
            --gradient-success: linear-gradient(135deg, var(--farm-green), var(--secondary-color));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        #appContainer {
            display: flex;
            height: 100vh;
        }

        /* 侧边栏样式 */
        #sidePanel {
            width: 280px;
            background: var(--card-background);
            box-shadow: var(--shadow-md);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            border-right: 3px solid var(--border-color);
            border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
        }

        .logo-section {
            padding: 0 5px 20px 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(124, 179, 66, 0.3);
        }

            .logo-section h4 {
                color: var(--dark-green);
                margin: 0;
                font-weight: 800;
                font-size: 1.3rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

        .nav-link-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.3s ease;
            background: var(--light-bg);
            border: 2px solid rgba(124, 179, 66, 0.2);
        }

            .nav-link-item:hover {
                background: var(--light-bg);
                color: var(--primary-color);
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(124, 179, 66, 0.2);
                border-color: var(--farm-green);
            }

            .nav-link-item i {
                margin-right: 15px;
                font-size: 18px;
            }

        .cart-fixed-btn {
            margin-top: auto;
            padding: 20px 0;
            border-top: 2px solid rgba(124, 179, 66, 0.3);
        }

        .cart-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: var(--border-radius-lg);
            background: var(--gradient-success);
            color: white;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

            .cart-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
                background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            }

        #cartCount {
            margin-left: 8px;
            min-width: 24px;
            height: 24px;
            line-height: 24px;
            background: #FF5722;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 2px 4px rgba(255, 87, 34, 0.3);
        }

        /* 主内容区域 */
        #mainContent {
            flex-grow: 1;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #topSection {
            margin-bottom: 20px;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--card-background);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            border: 3px solid var(--border-color);
            transition: all 0.3s ease;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: var(--shadow-lg);
                border-color: var(--farm-green);
            }

        .stat-icon {
            font-size: 28px;
            margin-right: 15px;
            color: var(--farm-green);
        }

        .stat-info h5 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #777;
            font-weight: 700;
        }

        .stat-info p {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            color: var(--dark-green);
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

            .search-bar input {
                flex-grow: 1;
                padding: 10px 20px;
                border: none;
                border-radius: var(--border-radius-lg);
                background: rgba(255, 255, 255, 0.9);
                font-size: 16px;
                box-shadow: var(--shadow-sm);
                border: 2px solid rgba(124, 179, 66, 0.2);
            }

            .search-bar button {
                padding: 0 25px;
                border: none;
                background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
                color: white;
                border-radius: var(--border-radius-lg);
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 5px;
            }

                .search-bar button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
                }

        .category-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(124, 179, 66, 0.3);
            padding-bottom: 15px;
        }

        .category-btn {
            padding: 8px 20px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: var(--light-bg);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

            .category-btn.active {
                background: linear-gradient(135deg, var(--dark-green), var(--primary-color));
                color: white;
                border-color: var(--primary-color);
                font-weight: 700;
                box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            }

            .category-btn:hover:not(.active) {
                transform: translateY(-2px);
                border-color: var(--farm-green);
                box-shadow: 0 3px 8px rgba(124, 179, 66, 0.2);
            }

        /* 产品列表 */
        #productsContainer {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding-bottom: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

            #productsContainer::-webkit-scrollbar {
                width: 8px;
            }

            #productsContainer::-webkit-scrollbar-thumb {
                background: rgba(124, 179, 66, 0.4);
                border-radius: 4px;
            }

            #productsContainer::-webkit-scrollbar-track {
                background: rgba(241, 248, 233, 0.5);
            }

        /* 产品卡片 */
        .product-card {
            background: var(--card-background);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            position: relative;
            border: 3px solid var(--border-color);
        }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: var(--shadow-lg);
                border-color: var(--farm-green);
            }

        .product-icon {
            font-size: 40px;
            text-align: center;
            margin-bottom: 15px;
            color: var(--farm-green);
        }

        .product-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: var(--dark-green);
        }

        .product-origin, .product-category {
            font-size: 12px;
            color: #777;
            margin-bottom: 5px;
        }

        .product-price {
            font-size: 22px;
            font-weight: 800;
            color: var(--accent-color);
            margin-top: auto;
            padding-top: 10px;
            display: flex;
            align-items: baseline;
        }

        .price-unit {
            font-size: 14px;
            font-weight: 600;
            color: #777;
            margin-left: 5px;
        }

        .stock-bar {
            height: 6px;
            background-color: #f1f8e9;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid rgba(124, 179, 66, 0.2);
        }

        .stock-level {
            height: 100%;
            background: var(--gradient-success);
            transition: width 0.5s;
        }

        /* 产品操作按钮 */
        .product-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed rgba(124, 179, 66, 0.3);
        }

        .action-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

            .action-btn i {
                margin-right: 5px;
            }

        .map-btn {
            background: linear-gradient(135deg, #1E88E5, var(--water-blue));
            color: white;
        }

            .map-btn:hover {
                background: linear-gradient(135deg, var(--water-blue), #4FC3F7);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(30, 136, 229, 0.4);
            }

        .add-cart-btn {
            background: var(--gradient-success);
            color: white;
        }

            .add-cart-btn:hover {
                background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
            }

        /* 分页 */
        #paginationContainer {
            padding: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            border-top: 2px solid rgba(124, 179, 66, 0.3);
        }

        .pagination-btn {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--light-bg);
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

            .pagination-btn:hover:not(:disabled) {
                background: var(--light-bg);
                border-color: var(--farm-green);
                transform: translateY(-2px);
            }

            .pagination-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        #paginationNumbers {
            display: flex;
            gap: 5px;
        }

        .pagination-number {
            padding: 8px 15px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

            .pagination-number.active {
                background: linear-gradient(135deg, var(--dark-green), var(--primary-color));
                color: white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            }

            .pagination-number:not(.active):hover {
                background: var(--light-bg);
                border-color: var(--border-color);
                transform: translateY(-2px);
            }

        #pageInfo {
            font-size: 14px;
            color: #777;
            margin-left: 15px;
            font-weight: 600;
        }

        /* 模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius-md);
            width: 450px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            border: 3px solid var(--border-color);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(124, 179, 66, 0.3);
            padding-bottom: 15px;
        }

            .modal-header h4 {
                margin: 0;
                font-weight: 800;
                color: var(--dark-green);
                font-size: 1.2rem;
            }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
        }

            .modal-close:hover {
                color: #F44336;
                transform: scale(1.1);
            }

        /* 购物车模态框 */
        .cart-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px dashed rgba(124, 179, 66, 0.3);
            transition: all 0.2s ease;
        }

            .cart-item:hover {
                transform: translateX(3px);
            }

        .cart-item-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--farm-green);
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--dark-green);
        }

        .cart-item-details {
            font-size: 12px;
            color: #777;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .cart-item-quantity-btn {
            background: var(--light-bg);
            border: 2px solid var(--border-color);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
        }

            .cart-item-quantity-btn:hover {
                background: var(--light-bg);
                border-color: var(--farm-green);
                transform: scale(1.1);
            }

        .cart-item-quantity-value {
            margin: 0 10px;
            width: 25px;
            text-align: center;
            font-weight: 700;
        }

        .cart-item-remove {
            background: none;
            border: none;
            color: #F44336;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
        }

            .cart-item-remove:hover {
                transform: scale(1.2);
                color: #D32F2F;
            }

        .cart-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid rgba(124, 179, 66, 0.3);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--dark-green);
        }

        .cart-actions button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

            .cart-actions button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }

        #checkoutBtn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
        }

        #clearCartBtn {
            background: linear-gradient(135deg, #F44336, #D32F2F);
            color: white;
        }

        .empty-cart {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        /* 添加购物车模态框 */
        .add-to-cart-info {
            text-align: center;
            margin-bottom: 20px;
        }

            .add-to-cart-info h5 {
                font-size: 20px;
                color: var(--dark-green);
                font-weight: 800;
            }

            .add-to-cart-info p {
                font-size: 18px;
                color: var(--accent-color);
                font-weight: 800;
            }

        .quantity-control {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

            .quantity-control button {
                background: var(--gradient-success);
                color: white;
                width: 45px;
                height: 45px;
                border: none;
                border-radius: 50%;
                font-size: 20px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-sm);
            }

                .quantity-control button:disabled {
                    background: #ccc;
                    cursor: not-allowed;
                    transform: none;
                }

                .quantity-control button:hover:not(:disabled) {
                    transform: scale(1.1);
                    box-shadow: 0 4px 8px rgba(124, 179, 66, 0.3);
                }

            .quantity-control #quantityValue {
                font-size: 24px;
                font-weight: 800;
                margin: 0 20px;
                min-width: 40px;
                text-align: center;
                color: var(--dark-green);
            }

        #addToCartFinalBtn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-success);
            color: white;
            font-size: 18px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

            #addToCartFinalBtn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
                background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            }

        /* 消息提示框 */
        #notificationContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }

        .notification {
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            font-weight: 700;
            display: none;
            min-width: 200px;
            border-left: 4px solid white;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            background: var(--gradient-success);
        }

        .notification.error {
            background: linear-gradient(135deg, #F44336, #D32F2F);
        }

        .no-data {
            text-align: center;
            padding: 50px;
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .no-data-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: #ccc;
        }

        .no-data .btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            font-weight: 700;
        }

            .no-data .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
            }

        .stat-card.map-stat .stat-icon {
            color: var(--water-blue);
        }

        .stat-card.product-stat .stat-icon {
            color: var(--farm-green);
        }

        .stat-card.delivery-stat .stat-icon {
            color: var(--accent-color);
        }

        .btn {
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

            .btn:hover {
                opacity: 0.95;
                transform: translateY(-2px);
            }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            #productsContainer {
                grid-template-columns: repeat(3, 1fr);
            }

            #sidePanel {
                width: 260px;
            }
        }

        @media (max-width: 992px) {
            #productsContainer {
                grid-template-columns: repeat(2, 1fr);
            }

            #sidePanel {
                width: 240px;
            }

            #mainContent {
                padding: 15px 20px;
            }
        }

        @media (max-width: 768px) {
            #appContainer {
                flex-direction: column;
            }

            #sidePanel {
                width: 100%;
                border-right: none;
                border-bottom: 3px solid var(--border-color);
                border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
                padding: 15px;
                height: auto;
                max-height: 200px;
                overflow-y: auto;
            }

            #productsContainer {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 90%;
                max-width: 400px;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="appContainer">
        <div id="sidePanel">
            <div class="logo-section">
                <h4><i class="bi bi-seedling"></i> 智慧农业平台</h4>
            </div>

            <div class="main-navigation">
                <div class="nav-link-item active">
                    <i class="bi bi-shop"></i> 产品商城
                </div>
                <div class="nav-link-item" onclick="window.location.href='map.html'">
                    <i class="bi bi-geo-alt-fill"></i> 查看配送地图
                </div>
                <div class="nav-link-item" onclick="window.location.href='trees.html'">
                    <i class="bi bi-tree-fill"></i> 云种树
                </div>
                <div class="nav-link-item" onclick="testBackend()">
                    <i class="bi bi-router"></i> 后端测试
                </div>
            </div>

            <div class="cart-fixed-btn">
                <button class="cart-btn" onclick="showCart()">
                    <i class="bi bi-cart-fill"></i> 购物车
                    <span id="cartCount">0</span>
                </button>
            </div>
        </div>

        <div id="mainContent">
            <div id="topSection">
                <div class="stats-container">
                    <div class="stat-card product-stat">
                        <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                        <div class="stat-info">
                            <h5>产品总数</h5>
                            <p id="totalProducts">0</p>
                        </div>
                    </div>
                    <div class="stat-card map-stat">
                        <div class="stat-icon"><i class="bi bi-truck"></i></div>
                        <div class="stat-info">
                            <h5>在途配送</h5>
                            <p id="activeDeliveries">0</p>
                        </div>
                    </div>
                    <div class="stat-card delivery-stat">
                        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                        <div class="stat-info">
                            <h5>库存状态</h5>
                            <p id="totalStock">--</p>
                        </div>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="搜索产品名称、产地或关键词...">
                    <button id="searchBtn"><i class="bi bi-search"></i> 搜索</button>
                </div>

                <div class="category-filter">
                    <div class="category-btn active" data-category="all">全部产品</div>
                    <div class="category-btn" data-category="生鲜类">生鲜类</div>
                    <div class="category-btn" data-category="粮油类">粮油类</div>
                    <div class="category-btn" data-category="饮品">饮品</div>
                    <div class="category-btn" data-category="加工品">加工品</div>
                    <div class="category-btn" data-category="副食品">副食品</div>
                    <div class="category-btn" data-category="其他">其他</div>
                </div>
            </div>

            <div id="productsContainer">
                <div class="no-data" id="loadingSpinner" style="grid-column: 1 / -1; color: #4CAF50;">
                    <i class="bi bi-arrow-clockwise" style="font-size: 50px; animation: spin 1s linear infinite;"></i>
                    <h5 style="margin-top: 15px;">正在加载产品数据...</h5>
                </div>
            </div>

            <div id="paginationContainer" style="flex-shrink: 0;">
                <button id="prevBtn" class="pagination-btn" onclick="prevPage()"><i class="bi bi-chevron-left"></i> 上一页</button>
                <div id="paginationNumbers"></div>
                <button id="nextBtn" class="pagination-btn" onclick="nextPage()">下一页 <i class="bi bi-chevron-right"></i></button>
                <span id="pageInfo"></span>
            </div>
        </div>
    </div>

    <!-- 购物车模态框 -->
    <div id="cartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="bi bi-cart-check"></i> 您的购物车</h4>
                <button class="modal-close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="cartItems" style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
            <div id="emptyCart" class="empty-cart" style="display: none;">
                <i class="bi bi-bag-x" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>购物车是空的</p>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>总金额:</span>
                    <span>¥<span id="cartTotalPrice">0.00</span></span>
                </div>
                <div class="cart-actions">
                    <button id="checkoutBtn" onclick="checkout()">去结算</button>
                    <button id="clearCartBtn" onclick="clearCart()">清空购物车</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加购物车模态框 -->
    <div id="addToCartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>添加到购物车</h4>
                <button class="modal-close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="add-to-cart-info">
                <h5 id="modalProductName">产品名称</h5>
                <p>单价：¥<span id="modalProductPrice">0.00</span> / 斤</p>
            </div>
            <div class="quantity-control">
                <button id="decreaseBtn" onclick="changeQuantity(-1)">-</button>
                <span id="quantityValue">1</span>
                <button id="increaseBtn" onclick="changeQuantity(1)">+</button>
            </div>
            <button id="addToCartFinalBtn" onclick="addToCart()"><i class="bi bi-plus-circle"></i> 确认加入购物车</button>
        </div>
    </div>

    <!-- 消息提示容器 -->
    <div id="notificationContainer"></div>

    <script>
        // 全局变量
        let allProducts = [];
        let currentCategory = 'all';
        let currentKeyword = '';
        let activeDeliveries = 0;
        let shoppingCart = [];
        let currentPage = 1;
        const itemsPerPage = 8;
        let currentSelectedProduct = null;
        let currentQuantity = 1;

        // --- 消息提示 ---
        function showNotification(message, type) {
            const container = $('#notificationContainer');
            const notification = $(`<div class="notification ${type}" style="opacity: 0;">${message}</div>`);
            container.append(notification);
            notification.animate({ opacity: 1 }, 300, function () {
                setTimeout(() => {
                    notification.animate({ opacity: 0 }, 500, function () {
                        notification.remove();
                    });
                }, 3000);
            });
        }
        function showSuccess(message) { showNotification(message, 'success'); }
        function showError(message) { showNotification(message, 'error'); }

        // --- 购物车相关 ---
        function updateCartCount() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            $('#cartCount').text(totalItems);
            localStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
        }

        function showCart() {
            renderCartItems();
            $('#cartModal').fadeIn();
        }

        function closeCart() {
            $('#cartModal').fadeOut();
        }

        function renderCartItems() {
            const cartItemsContainer = $('#cartItems');
            const emptyCart = $('#emptyCart');

            if (shoppingCart.length === 0) {
                emptyCart.show();
                cartItemsContainer.html('');
                $('#cartTotalPrice').text('0.00');
                return;
            }

            emptyCart.hide();

            const itemsHtml = shoppingCart.map((item, index) => `
                        <div class="cart-item">
                            <div class="cart-item-icon">${getProductIcon(item.product_name)}</div>
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.product_name}</div>
                                <div class="cart-item-details">
                                    ¥${item.price.toFixed(2)}/斤 · ${item.origin_name}
                                </div>
                            </div>
                            <div class="cart-item-quantity">
                                <button class="cart-item-quantity-btn" onclick="updateCartItemQuantity(${index}, -1)">-</button>
                                <div class="cart-item-quantity-value">${item.quantity}</div>
                                <button class="cart-item-quantity-btn" onclick="updateCartItemQuantity(${index}, 1)">+</button>
                            </div>
                            <button class="cart-item-remove" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `).join('');

            cartItemsContainer.html(itemsHtml);
            updateCartTotal();
        }

        function updateCartItemQuantity(index, change) {
            shoppingCart[index].quantity += change;
            if (shoppingCart[index].quantity <= 0) {
                shoppingCart.splice(index, 1);
            }
            renderCartItems();
            updateCartCount();
            showSuccess('购物车已更新');
        }

        function removeFromCart(index) {
            shoppingCart.splice(index, 1);
            renderCartItems();
            updateCartCount();
            showSuccess('已从购物车移除');
        }

        function clearCart() {
            if (shoppingCart.length === 0) return;
            if (confirm('确定要清空购物车吗？')) {
                shoppingCart = [];
                renderCartItems();
                updateCartCount();
                showSuccess('购物车已清空');
            }
        }

        function updateCartTotal() {
            const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            $('#cartTotalPrice').text(total.toFixed(2));
        }

        function checkout() {
            if (shoppingCart.length === 0) {
                showError('购物车是空的');
                return;
            }

            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (confirm(`确定要配送 ${totalItems} 件商品，总金额 ¥${totalPrice.toFixed(2)} 吗？`)) {
                activeDeliveries++;
                updateStats(allProducts);

                shoppingCart = [];
                renderCartItems();
                updateCartCount();
                closeCart();

                showSuccess(`开始配送 ${totalItems} 件商品，总金额 ¥${totalPrice.toFixed(2)}`);

                setTimeout(() => {
                    activeDeliveries = Math.max(0, activeDeliveries - 1);
                    updateStats(allProducts);
                }, 5000);
            }
        }

        // --- 分页相关 ---
        function updatePagination(filteredProducts) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const paginationContainer = $('#paginationContainer');
            const paginationNumbers = $('#paginationNumbers');
            const prevBtn = $('#prevBtn');
            const nextBtn = $('#nextBtn');
            const pageInfo = $('#pageInfo');

            if (totalPages <= 1) {
                paginationContainer.hide();
                return;
            }

            paginationContainer.show();
            prevBtn.prop('disabled', currentPage === 1);
            nextBtn.prop('disabled', currentPage === totalPages);

            let numbersHtml = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                numbersHtml += `<div class="pagination-number" onclick="goToPage(1)">1</div>`;
                if (startPage > 2) {
                    numbersHtml += `<div class="pagination-number" style="background: transparent; border: none; cursor: default;">...</div>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                numbersHtml += `<div class="pagination-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</div>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    numbersHtml += `<div class="pagination-number" style="background: transparent; border: none; cursor: default;">...</div>`;
                }
                numbersHtml += `<div class="pagination-number" onclick="goToPage(${totalPages})">${totalPages}</div>`;
            }

            paginationNumbers.html(numbersHtml);
            pageInfo.text(`第${currentPage}页，共${totalPages}页`);
        }

        function goToPage(page) {
            currentPage = page;
            filterAndDisplayProducts();
            $('#productsContainer').scrollTop(0);
        }

        function prevPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function nextPage() {
            const filteredProducts = getFilteredProducts();
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        // --- 添加购物车模态框 ---
        function showAddToCartModal(product) {
            currentSelectedProduct = product;
            currentQuantity = 1;
            $('#modalProductName').text(product.product_name);
            $('#modalProductPrice').text(parseFloat(product.price).toFixed(2));
            $('#quantityValue').text(currentQuantity);
            $('#decreaseBtn').prop('disabled', currentQuantity <= 1);
            $('#increaseBtn').prop('disabled', currentQuantity >= 100);
            $('#addToCartModal').fadeIn();
        }

        function closeAddToCartModal() {
            $('#addToCartModal').fadeOut();
            currentSelectedProduct = null;
            currentQuantity = 1;
        }

        function changeQuantity(change) {
            currentQuantity += change;
            if (currentQuantity < 1) currentQuantity = 1;
            if (currentQuantity > 100) currentQuantity = 100;

            $('#quantityValue').text(currentQuantity);
            $('#decreaseBtn').prop('disabled', currentQuantity <= 1);
            $('#increaseBtn').prop('disabled', currentQuantity >= 100);
        }

        function addToCart() {
            if (!currentSelectedProduct) return;

            const existingIndex = shoppingCart.findIndex(item => item.product_id === currentSelectedProduct.product_id);

            if (existingIndex > -1) {
                shoppingCart[existingIndex].quantity += currentQuantity;
            } else {
                shoppingCart.push({
                    product_id: currentSelectedProduct.product_id,
                    product_name: currentSelectedProduct.product_name,
                    price: parseFloat(currentSelectedProduct.price),
                    origin_name: currentSelectedProduct.origin_name || '未知产地',
                    quantity: currentQuantity
                });
            }

            updateCartCount();
            closeAddToCartModal();
            showSuccess(`已添加 ${currentQuantity} 件 ${currentSelectedProduct.product_name} 到购物车`);
        }

        // --- 产品分类/图标 ---
        function getProductCategory(productName, originType) {
            const productNameLower = productName.toLowerCase();

            // 生鲜类
            if (productNameLower.includes('白菜') || productNameLower.includes('萝卜') ||
                productNameLower.includes('黄瓜') || productNameLower.includes('番茄') ||
                productNameLower.includes('西红柿') || productNameLower.includes('土豆') ||
                productNameLower.includes('马铃薯') || productNameLower.includes('玉米') ||
                productNameLower.includes('茄子') || productNameLower.includes('青椒') ||
                productNameLower.includes('辣椒') || productNameLower.includes('蘑菇') ||
                productNameLower.includes('香菇') || productNameLower.includes('西兰花') ||
                productNameLower.includes('花菜') || productNameLower.includes('苹果') ||
                productNameLower.includes('香蕉') || productNameLower.includes('橙子') ||
                productNameLower.includes('柑橘') || productNameLower.includes('葡萄') ||
                productNameLower.includes('草莓') || productNameLower.includes('西瓜') ||
                productNameLower.includes('桃子') || productNameLower.includes('菠萝') ||
                productNameLower.includes('猕猴桃') || productNameLower.includes('芒果') ||
                productNameLower.includes('猪肉') || productNameLower.includes('牛肉') ||
                productNameLower.includes('鸡肉') || productNameLower.includes('羊肉') ||
                productNameLower.includes('火腿') || productNameLower.includes('鱼肉') ||
                productNameLower.includes('鲈鱼') || productNameLower.includes('带鱼') ||
                productNameLower.includes('虾') || productNameLower.includes('蟹') ||
                productNameLower.includes('贝') || productNameLower.includes('蛤') ||
                productNameLower.includes('扇贝') || productNameLower.includes('大闸蟹') ||
                originType === '果蔬基地' || originType === '水产码头' ||
                originType === '水果基地' || originType === '水产' ||
                originType === '养殖基地' || productNameLower.includes('生鲜') ||
                productNameLower.includes('新鲜') || productNameLower.includes('青菜') ||
                productNameLower.includes('菠菜') || productNameLower.includes('胡萝卜') ||
                productNameLower.includes('甜瓜') || productNameLower.includes('哈密瓜')) {
                return '生鲜类';
            }

            // 粮油类
            if (productNameLower.includes('大米') || productNameLower.includes('面粉') ||
                productNameLower.includes('小麦') || productNameLower.includes('小米') ||
                productNameLower.includes('玉米') || productNameLower.includes('油') ||
                productNameLower.includes('食用油') || productNameLower.includes('大豆') ||
                productNameLower.includes('花生油') || productNameLower.includes('菜籽油') ||
                originType === '粮食基地' || originType === '水稻基地' ||
                originType === '杂粮基地' || productNameLower.includes('粮油') ||
                productNameLower.includes('主食') || productNameLower.includes('米') ||
                productNameLower.includes('麦')) {
                return '粮油类';
            }

            // 饮品
            if (productNameLower.includes('茶') || productNameLower.includes('茶叶') ||
                productNameLower.includes('碧螺春') || productNameLower.includes('普洱茶') ||
                productNameLower.includes('铁观音') || productNameLower.includes('黄金芽') ||
                productNameLower.includes('酒') || productNameLower.includes('白酒') ||
                productNameLower.includes('啤酒') || productNameLower.includes('红酒') ||
                productNameLower.includes('奶') || productNameLower.includes('牛奶') ||
                productNameLower.includes('酸奶') || productNameLower.includes('汁') ||
                productNameLower.includes('果汁') || productNameLower.includes('饮料') ||
                productNameLower.includes('咖啡') || productNameLower.includes('可乐') ||
                originType === '茶叶基地' || originType === '茶园' ||
                productNameLower.includes('饮品') || productNameLower.includes('泡茶')) {
                return '饮品';
            }

            // 加工品
            if (productNameLower.includes('火腿') || productNameLower.includes('肠') ||
                productNameLower.includes('火腿肠') || productNameLower.includes('饼') ||
                productNameLower.includes('糕') || productNameLower.includes('柿饼') ||
                productNameLower.includes('面') || productNameLower.includes('条') ||
                productNameLower.includes('粉') || productNameLower.includes('面条') ||
                productNameLower.includes('米粉') || productNameLower.includes('罐头') ||
                productNameLower.includes('酱') || productNameLower.includes('海苔') ||
                productNameLower.includes('鱼块') || productNameLower.includes('鲈鱼块') ||
                originType === '加工厂' || originType === '食品厂' ||
                originType === '面粉厂' || originType === '工坊' ||
                productNameLower.includes('速冻') || productNameLower.includes('预制') ||
                productNameLower.includes('即食') || productNameLower.includes('加工')) {
                return '加工品';
            }

            // 副食品
            if (productNameLower.includes('花椒') || productNameLower.includes('辣椒') ||
                productNameLower.includes('胡椒') || productNameLower.includes('醋') ||
                productNameLower.includes('酱油') || productNameLower.includes('酱') ||
                productNameLower.includes('干') || productNameLower.includes('枣') ||
                productNameLower.includes('核桃') || productNameLower.includes('枸杞') ||
                productNameLower.includes('红枸杞') || productNameLower.includes('调料') ||
                productNameLower.includes('调味') || productNameLower.includes('干货') ||
                productNameLower.includes('零嘴') || productNameLower.includes('坚果') ||
                productNameLower.includes('瓜子') || productNameLower.includes('花生') ||
                productNameLower.includes('杏仁') || productNameLower.includes('蜜饯')) {
                return '副食品';
            }

            return '其他';
        }

        function getProductIcon(productName) {
            const productNameLower = productName.toLowerCase();

            // 蔬菜类
            if (productNameLower.includes('白菜') || productNameLower.includes('青菜') || productNameLower.includes('菠菜') || productNameLower.includes('油菜')) return '🥬';
            if (productNameLower.includes('萝卜') || productNameLower.includes('胡萝卜') || productNameLower.includes('白萝卜')) return '🥕';
            if (productNameLower.includes('黄瓜') || productNameLower.includes('青瓜')) return '🥒';
            if (productNameLower.includes('番茄') || productNameLower.includes('西红柿')) return '🍅';
            if (productNameLower.includes('土豆') || productNameLower.includes('马铃薯') || productNameLower.includes('洋芋')) return '🥔';
            if (productNameLower.includes('玉米') || productNameLower.includes('苞谷') || productNameLower.includes('包谷')) return '🌽';
            if (productNameLower.includes('茄子') || productNameLower.includes('紫茄')) return '🍆';
            if (productNameLower.includes('青椒') || productNameLower.includes('辣椒') || productNameLower.includes('尖椒')) return '🫑';
            if (productNameLower.includes('蘑菇') || productNameLower.includes('香菇') || productNameLower.includes('金针菇') || productNameLower.includes('杏鲍菇')) return '🍄';
            if (productNameLower.includes('西兰花') || productNameLower.includes('花菜') || productNameLower.includes('花椰菜')) return '🥦';
            if (productNameLower.includes('洋葱')) return '🧅';
            if (productNameLower.includes('蒜') || productNameLower.includes('大蒜')) return '🧄';
            if (productNameLower.includes('姜') || productNameLower.includes('生姜')) return '🫚';
            if (productNameLower.includes('芹菜')) return '🌿';
            if (productNameLower.includes('韭菜')) return '🌱';
            if (productNameLower.includes('藕') || productNameLower.includes('莲藕')) return '🌾';
            if (productNameLower.includes('豆角') || productNameLower.includes('豇豆')) return '🫛';
            if (productNameLower.includes('豌豆')) return '🫛';
            if (productNameLower.includes('南瓜')) return '🎃';
            if (productNameLower.includes('冬瓜')) return '🍈';

            // 水果类
            if (productNameLower.includes('苹果') || productNameLower.includes('红富士') || productNameLower.includes('洛川苹果')) return '🍎';
            if (productNameLower.includes('香蕉') || productNameLower.includes('芭蕉')) return '🍌';
            if (productNameLower.includes('橙子') || productNameLower.includes('柑橘') || productNameLower.includes('脐橙') || productNameLower.includes('九月红')) return '🍊';
            if (productNameLower.includes('葡萄') || productNameLower.includes('提子')) return '🍇';
            if (productNameLower.includes('草莓')) return '🍓';
            if (productNameLower.includes('西瓜')) return '🍉';
            if (productNameLower.includes('桃子') || productNameLower.includes('水蜜桃') || productNameLower.includes('蟠桃')) return '🍑';
            if (productNameLower.includes('菠萝') || productNameLower.includes('凤梨')) return '🍍';
            if (productNameLower.includes('猕猴桃') || productNameLower.includes('奇异果')) return '🥝';
            if (productNameLower.includes('芒果')) return '🥭';
            if (productNameLower.includes('梨') || productNameLower.includes('鸭梨') || productNameLower.includes('雪梨')) return '🍐';
            if (productNameLower.includes('柿子') || productNameLower.includes('柿饼')) return '🍅';
            if (productNameLower.includes('甜瓜') || productNameLower.includes('哈密瓜') || productNameLower.includes('蜜宝')) return '🍈';
            if (productNameLower.includes('樱桃')) return '🍒';
            if (productNameLower.includes('石榴')) return '🍎';
            if (productNameLower.includes('柚子') || productNameLower.includes('蜜柚')) return '🍊';
            if (productNameLower.includes('柠檬')) return '🍋';

            // 肉类
            if (productNameLower.includes('猪肉') || productNameLower.includes('五花肉') || productNameLower.includes('瘦肉')) return '🥩';
            if (productNameLower.includes('牛肉') || productNameLower.includes('牛排') || productNameLower.includes('牛腩')) return '🥩';
            if (productNameLower.includes('鸡肉') || productNameLower.includes('鸡腿') || productNameLower.includes('鸡翅')) return '🍗';
            if (productNameLower.includes('羊肉') || productNameLower.includes('羊排')) return '🥩';
            if (productNameLower.includes('火腿') || productNameLower.includes('腊肉')) return '🥓';
            if (productNameLower.includes('香肠') || productNameLower.includes('腊肠')) return '🌭';

            // 水产类
            if (productNameLower.includes('鱼') || productNameLower.includes('鲈鱼') || productNameLower.includes('带鱼') || productNameLower.includes('鲫鱼') || productNameLower.includes('鱼块')) return '🐟';
            if (productNameLower.includes('虾') || productNameLower.includes('大虾') || productNameLower.includes('基围虾') || productNameLower.includes('龙虾')) return '🦐';
            if (productNameLower.includes('蟹') || productNameLower.includes('大闸蟹') || productNameLower.includes('螃蟹') || productNameLower.includes('河蟹')) return '🦀';
            if (productNameLower.includes('贝') || productNameLower.includes('蛤') || productNameLower.includes('扇贝')) return '🐚';
            if (productNameLower.includes('海带') || productNameLower.includes('紫菜') || productNameLower.includes('海苔')) return '🌿';

            // 粮油类
            if (productNameLower.includes('大米') || productNameLower.includes('粳米') || productNameLower.includes('籼米') || productNameLower.includes('珍珠米')) return '🍚';
            if (productNameLower.includes('面粉') || productNameLower.includes('小麦粉') || productNameLower.includes('全麦粉')) return '🌾';
            if (productNameLower.includes('油') || productNameLower.includes('花生油') || productNameLower.includes('菜籽油') || productNameLower.includes('豆油')) return '🫙';
            if (productNameLower.includes('小米') || productNameLower.includes('黄米')) return '🌾';
            if (productNameLower.includes('糯米')) return '🍚';
            if (productNameLower.includes('燕麦')) return '🌾';

            // 饮品
            if (productNameLower.includes('茶') || productNameLower.includes('碧螺春') || productNameLower.includes('普洱茶') || productNameLower.includes('铁观音') || productNameLower.includes('龙井')) return '🍵';
            if (productNameLower.includes('酒') || productNameLower.includes('白酒') || productNameLower.includes('啤酒') || productNameLower.includes('红酒')) return '🍶';
            if (productNameLower.includes('奶') || productNameLower.includes('牛奶') || productNameLower.includes('酸奶')) return '🥛';
            if (productNameLower.includes('果汁') || productNameLower.includes('橙汁') || productNameLower.includes('苹果汁')) return '🧃';
            if (productNameLower.includes('咖啡')) return '☕';

            // 加工品
            if (productNameLower.includes('饼') || productNameLower.includes('糕') || productNameLower.includes('柿饼') || productNameLower.includes('月饼')) return '🥮';
            if (productNameLower.includes('面') || productNameLower.includes('条') || productNameLower.includes('粉') || productNameLower.includes('面条')) return '🍜';
            if (productNameLower.includes('肠') || productNameLower.includes('火腿肠') || productNameLower.includes('香肠')) return '🌭';
            if (productNameLower.includes('罐头') || productNameLower.includes('鱼罐头')) return '🥫';
            if (productNameLower.includes('酱') || productNameLower.includes('豆瓣酱')) return '🧂';
            if (productNameLower.includes('豆腐') || productNameLower.includes('豆干')) return '🫘';
            if (productNameLower.includes('面包')) return '🍞';

            // 副食品
            if (productNameLower.includes('花椒') || productNameLower.includes('辣椒') || productNameLower.includes('胡椒') || productNameLower.includes('八角')) return '🌶️';
            if (productNameLower.includes('醋') || productNameLower.includes('酱油') || productNameLower.includes('酱')) return '🧂';
            if (productNameLower.includes('枣') || productNameLower.includes('红枣')) return '🫘';
            if (productNameLower.includes('核桃') || productNameLower.includes('山核桃')) return '🥜';
            if (productNameLower.includes('枸杞') || productNameLower.includes('红枸杞')) return '🫘';
            if (productNameLower.includes('坚果') || productNameLower.includes('腰果') || productNameLower.includes('杏仁')) return '🥜';
            if (productNameLower.includes('花生')) return '🥜';
            if (productNameLower.includes('芝麻')) return '⚫';
            if (productNameLower.includes('糖') || productNameLower.includes('白糖')) return '🍬';

            return '🌱';
        }

        // --- 核心功能 ---
        $(document).ready(function () {
            console.log('页面加载完成，开始初始化...');

            // 加载购物车
            const savedCart = localStorage.getItem('shoppingCart');
            if (savedCart) {
                try {
                    shoppingCart = JSON.parse(savedCart);
                    updateCartCount();
                } catch (e) {
                    console.error('购物车数据解析失败:', e);
                    shoppingCart = [];
                }
            }

            // 加载产品数据
            loadProducts();

            // 绑定事件
            bindEvents();
        });

        function bindEvents() {
            // 搜索按钮
            $('#searchBtn').click(searchProducts);

            // 回车搜索
            $('#searchInput').keypress(function (e) {
                if (e.which === 13) searchProducts();
            });

            // 分类筛选按钮
            $('.category-btn').click(function () {
                $('.category-btn').removeClass('active');
                $(this).addClass('active');
                currentCategory = $(this).data('category');
                currentPage = 1;
                filterAndDisplayProducts();
            });

            // 点击模态框外部关闭
            $('.modal-overlay').click(function (e) {
                if (e.target === this) {
                    $(this).fadeOut();
                    currentSelectedProduct = null;
                    currentQuantity = 1;
                }
            });

            // 关闭按钮事件
            $('.modal-close').click(function () {
                $(this).closest('.modal-overlay').fadeOut();
                currentSelectedProduct = null;
                currentQuantity = 1;
            });
        }

        function testBackend() {
            $.ajax({
                url: 'Handler1.ashx?action=test',
                type: 'GET',
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    console.log('后端连接测试成功:', response);
                    showSuccess('后端连接成功！');
                },
                error: function (xhr, status, error) {
                    console.error('后端连接测试失败:', error);
                    showError('后端连接失败，请检查服务器配置');
                }
            });
        }

        function loadProducts() {
            console.log('正在加载产品数据...');

            // 重置产品列表
            $('#productsContainer').html(`
                        <div class="no-data" id="loadingSpinner" style="grid-column: 1 / -1; color: #4CAF50;">
                            <i class="bi bi-arrow-clockwise" style="font-size: 50px; animation: spin 1s linear infinite;"></i>
                            <h5 style="margin-top: 15px;">正在加载产品数据...</h5>
                        </div>
                    `);

            $.ajax({
                url: 'Handler1.ashx?action=getAllProducts',
                type: 'GET',
                dataType: 'json',
                success: function (products) {
                    console.log('产品数据加载成功:', products);
                    $('#loadingSpinner').remove();

                    if (products && products.length > 0) {
                        allProducts = products.map(product => {
                            return {
                                ...product,
                                category: getProductCategory(product.product_name, product.origin_type)
                            };
                        });

                        filterAndDisplayProducts();
                        updateStats(allProducts);
                        showSuccess('成功加载 ' + products.length + ' 个农产品');
                    } else {
                        showError('未找到产品数据');
                        $('#productsContainer').html(`
                                    <div class="no-data">
                                        <div class="no-data-icon">
                                            <i class="bi bi-emoji-frown"></i>
                                        </div>
                                        <h5 style="margin-bottom: 10px; font-weight: 600;">未找到农产品数据</h5>
                                        <p class="text-muted" style="margin-bottom: 15px;">请检查后端连接或重新加载</p>
                                        <button class="btn btn-success" onclick="loadProducts()" style="padding: 8px 16px; border-radius: var(--border-radius-sm); border: none; background: var(--gradient-success); color: white; font-weight: 600; cursor: pointer;">
                                            <i class="bi bi-arrow-clockwise"></i> 重新加载
                                        </button>
                                    </div>
                                `);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('加载产品失败:', error);
                    $('#loadingSpinner').remove();
                    showError('加载产品失败: ' + (error || '未知错误'));
                    $('#productsContainer').html(`
                                <div class="no-data">
                                    <div class="no-data-icon">
                                        <i class="bi bi-wifi-off"></i>
                                    </div>
                                    <h5 style="margin-bottom: 10px; font-weight: 600;">连接后端服务器失败</h5>
                                    <p class="text-muted" style="margin-bottom: 15px;">请检查网络连接并确保后端服务正在运行</p>
                                    <button class="btn btn-success" onclick="loadProducts()" style="padding: 8px 16px; border-radius: var(--border-radius-sm); border: none; background: var(--gradient-success); color: white; font-weight: 600; cursor: pointer;">
                                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                                    </button>
                                </div>
                            `);
                }
            });
        }

        function searchProducts() {
            currentKeyword = $('#searchInput').val().trim();
            currentPage = 1;
            filterAndDisplayProducts();
        }

        function clearFilters() {
            currentKeyword = '';
            $('#searchInput').val('');
            currentCategory = 'all';
            $('.category-btn').removeClass('active');
            $('[data-category="all"]').addClass('active');
            currentPage = 1;
            filterAndDisplayProducts();
        }

        function updateStats(filteredProducts) {
            $('#totalProducts').text(filteredProducts.length);
            $('#activeDeliveries').text(activeDeliveries);

            const totalStock = filteredProducts.reduce((sum, p) => sum + parseInt(p.stock || 0), 0);
            const stockStatusText = totalStock > 5000 ? '充足' : (totalStock > 1000 ? '一般' : '紧张');
            $('#totalStock').html(`${totalStock.toLocaleString()} 斤 (<span style="color: ${totalStock > 5000 ? 'var(--secondary-color)' : (totalStock > 1000 ? 'var(--accent-color)' : '#F44336')}">${stockStatusText}</span>)`);
        }

        function getFilteredProducts() {
            let filteredProducts = allProducts;

            if (currentCategory !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
            }

            if (currentKeyword) {
                const keyword = currentKeyword.toLowerCase();
                filteredProducts = filteredProducts.filter(p =>
                    (p.product_name && p.product_name.toLowerCase().includes(keyword)) ||
                    (p.origin_name && p.origin_name.toLowerCase().includes(keyword)) ||
                    (p.description && p.description.toLowerCase().includes(keyword)) ||
                    (p.province && p.province.toLowerCase().includes(keyword)) ||
                    (p.category && p.category.toLowerCase().includes(keyword))
                );
            }

            return filteredProducts;
        }

        function filterAndDisplayProducts() {
            const filteredProducts = getFilteredProducts();
            displayProducts(filteredProducts);
            updatePagination(filteredProducts);
            updateStats(filteredProducts);
        }

        function displayProducts(filteredProducts) {
            const container = $('#productsContainer');
            container.empty();

            if (!filteredProducts || filteredProducts.length === 0) {
                container.html(`
                            <div class="no-data">
                                <div class="no-data-icon">
                                    <i class="bi bi-search"></i>
                                </div>
                                <h5 style="margin-bottom: 10px; font-weight: 600;">未找到相关农产品</h5>
                                <p class="text-muted" style="margin-bottom: 15px;">请尝试其他搜索条件或分类</p>
                                <button class="btn btn-outline-success" onclick="clearFilters()" style="padding: 8px 16px; border-radius: var(--border-radius-sm); border: 2px solid var(--secondary-color); background: transparent; color: var(--secondary-color); font-weight: 600; cursor: pointer;">
                                    <i class="bi bi-x-circle"></i> 清除筛选
                                </button>
                            </div>
                        `);
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            pageProducts.forEach(product => {
                const stock = parseInt(product.stock || 0);
                const maxStockDisplay = 1000;
                const stockPercent = Math.min((stock / maxStockDisplay) * 100, 100);
                const stockStatus = stock > 100 ? '充足' : (stock > 20 ? '一般' : '紧张');

                const card = `
                            <div class="product-card">
                                <div class="product-icon">
                                    ${getProductIcon(product.product_name)}
                                </div>
                                <div class="product-name">
                                    ${product.product_name}
                                </div>
                                <div class="product-category">
                                    ${product.category || '未分类'}
                                </div>
                                <div class="product-origin">
                                    <i class="bi bi-geo-alt"></i>
                                    <span>${product.origin_name}</span>
                                </div>
                                <div class="product-price">
                                    ¥${parseFloat(product.price).toFixed(2)}<span class="price-unit">/斤</span>
                                </div>
                                <div class="stock-bar">
                                    <div class="stock-level" style="width: ${stockPercent}%; background: ${stockPercent > 50 ? 'var(--gradient-success)' : (stockPercent > 10 ? 'linear-gradient(45deg, #FF9800, #FFB300)' : 'linear-gradient(45deg, #F44336, #FF5722)')}"></div>
                                </div>
                                <div class="product-actions">
                                    <button class="action-btn map-btn" onclick="goToMapWithProduct(${JSON.stringify(product).replace(/"/g, '&quot;').replace(/'/g, "\\'")})">
                                        <i class="bi bi-pin-map"></i> 配送地图
                                    </button>
                                    <button class="action-btn add-cart-btn" onclick="showAddToCartModal(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                        <i class="bi bi-bag-plus"></i> 加入购物车
                                    </button>
                                </div>
                            </div>
                        `;
                container.append(card);
            });
        }

        // 新增函数：跳转到地图页面并传递产品信息
        function goToMapWithProduct(product) {
            // 将产品信息存储到 sessionStorage
            const productInfo = {
                id: product.product_id,
                name: product.product_name,
                origin_name: product.origin_name,
                origin_type: product.origin_type,
                price: product.price,
                stock: product.stock,
                province: product.province,
                origin_lat: product.origin_lat,
                origin_lng: product.origin_lng,
                unit: product.unit || '斤'
            };

            sessionStorage.setItem('selectedProduct', JSON.stringify(productInfo));

            // 跳转到地图页面
            window.location.href = 'map.html';
        }
    </script>
</body>
</html>