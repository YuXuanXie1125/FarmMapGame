<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国农产品产地地图 - 农产品直供系统</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --light-color: #F1F8E9;
            --danger-color: #FF5722;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --success-color: #66BB6A;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        /* 顶部导航栏 */
        .top-navbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(46, 125, 50, 0.1);
        }

        .system-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 220px;
        }

        .nav-center-area {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
            max-width: 650px;
        }

        .real-time-clock {
            font-size: 0.9rem;
            font-weight: 700;
            color: #2196F3;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            white-space: nowrap;
        }

        .search-container {
            flex: 1;
            max-width: 350px;
        }

        .search-input-group {
            display: flex;
            gap: 6px;
        }

        .search-input {
            flex: 1;
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 180px;
        }

            .search-input:focus {
                outline: none;
                border-color: var(--secondary-color);
                box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            }

        .search-btn {
            padding: 8px 18px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

            .search-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            }

        .nav-right-area {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 350px;
            justify-content: flex-end;
        }

        .top-control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .top-control-btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }

        .top-control-btn-info {
            background: linear-gradient(135deg, var(--info-color), #1976D2);
            color: white;
        }

        .top-control-btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #E64A19);
            color: white;
        }

        .top-control-btn-success {
            background: linear-gradient(135deg, var(--success-color), #43A047);
            color: white;
        }

        .top-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* 左侧控制面板 */
        .left-control-panel {
            position: absolute;
            top: 70px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
            backdrop-filter: blur(10px);
            width: 300px;
            height: auto;
            overflow: visible;
            border: 1px solid rgba(46, 125, 50, 0.1);
        }

        /* 右侧信息面板 */
        .right-info-panel {
            position: absolute;
            top: 70px;
            right: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
            backdrop-filter: blur(10px);
            width: 350px;
            height: auto;
            overflow: visible;
            border: 1px solid rgba(46, 125, 50, 0.1);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-section {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(241, 248, 233, 0.2);
            border-radius: 10px;
            border-left: 4px solid var(--secondary-color);
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 控制按钮组 */
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        .control-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .control-btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }

        .control-btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #E64A19);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* 筛选按钮组 */
        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
            margin-bottom: 12px;
        }

        .filter-btn {
            padding: 6px 10px;
            border: 2px solid var(--secondary-color);
            background: white;
            color: var(--secondary-color);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

            .filter-btn.active {
                background: var(--secondary-color);
                color: white;
            }

            .filter-btn:hover {
                transform: translateY(-1px);
            }

        /* 产品信息卡片 */
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

            .product-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.12);
            }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 8px;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .product-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #FF5722;
            white-space: nowrap;
        }

        .product-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .detail-item {
            font-size: 0.8rem;
            color: #666;
            padding: 6px;
            background: rgba(241, 248, 233, 0.3);
            border-radius: 5px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }

        /* 数量选择器 */
        .quantity-selector {
            margin: 15px 0;
            padding: 10px;
            background: rgba(241, 248, 233, 0.3);
            border-radius: 8px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .quantity-btn {
            width: 35px;
            height: 35px;
            border: 2px solid var(--secondary-color);
            background: white;
            color: var(--secondary-color);
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

            .quantity-btn:hover {
                background: var(--secondary-color);
                color: white;
            }

        .quantity-input {
            flex: 1;
            text-align: center;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
        }

            .quantity-input:focus {
                outline: none;
                border-color: var(--secondary-color);
            }

        /* 地图标记样式 */
        .product-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .product-dot:hover {
                transform: scale(1.4);
                z-index: 1000;
                box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            }

            .product-dot.selected {
                transform: scale(1.6);
                box-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
                animation: pulse 1.5s infinite;
            }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .destination-marker {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 3px 12px rgba(33, 150, 243, 0.4);
        }

        .vehicle-marker {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #FF5722, #E64A19);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(255, 87, 34, 0.4);
            animation: vehicle-pulse 2s infinite;
        }

        @keyframes vehicle-pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* 路线样式 */
        .route-path {
            stroke: #9C27B0;
            stroke-width: 4;
            stroke-opacity: 0.8;
            fill: none;
            stroke-linecap: round;
            stroke-dasharray: 10, 10;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -20;
            }
        }

        /* 进度条 */
        .progress-container {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            width: 450px;
            max-width: 90%;
            text-align: center;
            display: none;
            backdrop-filter: blur(10px);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        /* 统计数据卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stats-item {
            padding: 6px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border-radius: 6px;
            background: rgba(241, 248, 233, 0.3);
        }

        .stats-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .stats-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--info-color);
        }

        /* 图例说明 */
        .legend-container {
            margin-top: 8px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .legend-text {
            font-size: 0.75rem;
            color: #333;
        }

        /* 热力图图例 */
        .heatmap-legend-container {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 243, 224, 0.3);
            border-radius: 8px;
            border-left: 3px solid var(--warning-color);
            display: none;
        }

        .heatmap-legend-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--warning-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .heatmap-gradient {
            height: 10px;
            width: 100%;
            background: linear-gradient(to right, blue, cyan, lime, yellow, orange, red);
            border-radius: 5px;
            margin: 6px 0;
        }

        .heatmap-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
            font-weight: 600;
        }

        /* 配送成功面板 */
        .delivery-success-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            text-align: center;
            width: 350px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .success-icon {
            font-size: 3rem;
            color: #4CAF50;
            margin-bottom: 15px;
            animation: successScale 0.6s ease;
        }

        @keyframes successScale {
            0% {
                transform: scale(0);
            }

            70% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2E7D32;
            margin-bottom: 12px;
        }

        .success-message {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .success-details {
            background: #F1F8E9;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            text-align: left;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .detail-label {
            color: #666;
            font-weight: 600;
        }

        .detail-value {
            color: #333;
            font-weight: 700;
        }

        /* 移除滚动条 */
        .left-control-panel::-webkit-scrollbar,
        .right-info-panel::-webkit-scrollbar {
            display: none;
        }

        .left-control-panel,
        .right-info-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 响应式调整 */
        @media (max-width: 1400px) {
            .left-control-panel {
                width: 280px;
                padding: 18px;
            }

            .right-info-panel {
                width: 320px;
                padding: 18px;
            }

            .nav-center-area {
                max-width: 600px;
            }

            .nav-right-area {
                min-width: 320px;
            }
        }

        @media (max-width: 1200px) {
            .top-navbar {
                flex-wrap: wrap;
                padding: 10px 15px;
            }

            .system-title {
                min-width: 180px;
                font-size: 1.1rem;
            }

            .nav-center-area {
                order: 3;
                flex: 100%;
                max-width: 100%;
                margin-top: 8px;
            }

            .nav-right-area {
                min-width: auto;
            }
        }

        /* 颜色定义 */
        .color-direct {
            background: #4CAF50;
        }

        .color-factory {
            background: #FF9800;
        }

        .color-harbor {
            background: #2196F3;
        }

        .color-base {
            background: #FFC107;
        }

        .color-grain {
            background: #9C27B0;
        }

        .color-other {
            background: #795548;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="top-navbar">
        <div class="system-title">
            <i class="bi bi-geo-alt-fill" style="font-size: 1.3rem;"></i>
            全国农产品产地地图系统
        </div>

        <div class="nav-center-area">
            <div class="real-time-clock" id="realTimeClock">
                <i class="bi bi-clock"></i>
                <span id="currentTime">加载中...</span>
            </div>

            <div class="search-container">
                <div class="search-input-group">
                    <input type="text" id="productSearch" class="search-input" placeholder="搜索产品、产地或省份...">
                    <button class="search-btn" id="searchBtn">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="nav-right-area">
            <button class="top-control-btn top-control-btn-primary" onclick="location.href='index.html'">
                <i class="bi bi-house-door"></i> 返回首页
            </button>
            <button class="top-control-btn top-control-btn-success" onclick="location.href='trees.html'">
                <i class="bi bi-tree"></i> 云种树
            </button>
            <button class="top-control-btn top-control-btn-info" id="viewControlBtn">
                <i class="bi bi-arrow-repeat"></i> 重置视图
            </button>
            <button class="top-control-btn top-control-btn-danger" id="heatmapToggleBtn">
                <i class="bi bi-fire"></i> 热力图开关
            </button>
            <div class="system-status">
                <span class="badge bg-success" style="font-size: 0.75rem; font-weight: 600; padding: 5px 10px;" id="systemStatus">在线</span>
            </div>
        </div>
    </div>

    <!-- 左侧控制面板 -->
    <div class="left-control-panel">
        <div class="panel-title">
            <i class="bi bi-sliders"></i> 地图控制
        </div>

        <!-- 地图控制 -->
        <div class="panel-section">
            <div class="section-title">
                <i class="bi bi-map"></i> 地图类型
            </div>
            <div class="mt-2">
                <div class="d-flex gap-2">
                    <button class="filter-btn active" data-layer="osm">标准地图</button>
                    <button class="filter-btn" data-layer="satellite">卫星地图</button>
                </div>
            </div>
        </div>

        <!-- 筛选控制 -->
        <div class="panel-section">
            <div class="section-title">
                <i class="bi bi-filter"></i> 筛选控制
            </div>

            <div class="mb-2">
                <label class="form-label" style="font-size: 0.8rem; font-weight: 600;">
                    <i class="bi bi-geo-alt"></i> 省份筛选
                </label>
                <select class="form-select" id="provinceSelect" style="font-size: 0.85rem; padding: 8px; border-radius: 6px;">
                    <option value="all">全部省份</option>
                </select>
            </div>

            <div class="mb-2">
                <label class="form-label" style="font-size: 0.8rem; font-weight: 600;">
                    <i class="bi bi-tags"></i> 产品类型
                </label>
                <div class="filter-buttons" id="productTypeFilters">
                    <!-- 动态生成产品类型筛选按钮 -->
                </div>
            </div>
        </div>

        <!-- 图例说明 -->
        <div class="panel-section">
            <div class="section-title">
                <i class="bi bi-palette"></i> 产品类型图例
            </div>
            <div class="legend-container">
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-color color-direct"></div>
                        <span class="legend-text">产地直销店</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-factory"></div>
                        <span class="legend-text">加工厂</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-harbor"></div>
                        <span class="legend-text">水产码头</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-base"></div>
                        <span class="legend-text">果蔬基地</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-grain"></div>
                        <span class="legend-text">粮食基地</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 热力图图例 -->
        <div class="heatmap-legend-container" id="heatmapLegend">
            <div class="heatmap-legend-title">
                <i class="bi bi-fire"></i> 热力图图例
            </div>
            <div class="heatmap-gradient"></div>
            <div class="heatmap-labels">
                <span>低密度</span>
                <span>高密度</span>
            </div>
        </div>
    </div>

    <!-- 右侧信息面板 -->
    <div class="right-info-panel">
        <div class="panel-title">
            <i class="bi bi-info-circle"></i> 产品信息
        </div>

        <!-- 当前选中产品 -->
        <div class="panel-section" id="currentProductSection" style="display: none;">
            <div class="section-title">
                <i class="bi bi-check-circle"></i> 当前选中产品
            </div>
            <div id="currentProductCard">
                <!-- 动态加载产品信息 -->
            </div>

            <!-- 数量选择器 -->
            <div class="quantity-selector" id="quantitySelector" style="display: none;">
                <div class="section-title">
                    <i class="bi bi-cart-plus"></i> 配送数量
                </div>
                <div class="quantity-controls">
                    <button class="quantity-btn" id="decreaseBtn">-</button>
                    <input type="number" id="deliveryQuantity" class="quantity-input" value="1" min="1" max="1000">
                    <button class="quantity-btn" id="increaseBtn">+</button>
                </div>
                <div class="mt-2 text-center">
                    <small class="text-muted" id="quantityHint">最大可配送: <span id="maxQuantity">0</span> 斤</small>
                </div>
            </div>

            <button class="control-btn control-btn-primary w-100 mt-2" id="startDeliveryBtn">
                <i class="bi bi-truck me-2"></i> 开始配送
            </button>
        </div>

        <!-- 统计数据 -->
        <div class="panel-section">
            <div class="section-title">
                <i class="bi bi-bar-chart"></i> 统计数据
            </div>
            <div class="stats-grid">
                <div class="stats-item">
                    <span class="stats-label">显示产品数量</span>
                    <span class="stats-value" id="visibleProducts">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">覆盖省份</span>
                    <span class="stats-value" id="visibleProvinces">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">产品类型</span>
                    <span class="stats-value" id="visibleProductTypes">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">配送中数量</span>
                    <span class="stats-value" id="activeDeliveries">0</span>
                </div>
            </div>
            <div class="mt-2 text-center">
                <small class="text-muted">更新时间: <span id="dataUpdateTime">--:--:--</span></small>
            </div>
        </div>
    </div>

    <!-- 配送成功面板 -->
    <div class="delivery-success-panel" id="deliverySuccessPanel">
        <div class="success-icon">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="success-title">配送成功！</div>
        <div class="success-message">
            您的订单已成功送达目的地<br>
            感谢您选择我们的配送服务
        </div>
        <div class="success-details" id="successDetails">
            <!-- 动态填充配送详情 -->
        </div>
        <button class="control-btn control-btn-primary w-100 mt-2" id="closeSuccessPanelBtn">
            <i class="bi bi-check-circle me-2"></i> 确认
        </button>
    </div>

    <!-- 进度条容器 -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <h6 id="deliveryTitle" style="font-size: 0.9rem; font-weight: 600;">全国配送进度</h6>
            <span id="deliveryStatus" class="text-muted" style="font-size: 0.8rem;">准备中...</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="deliveryProgress"></div>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 使用简单的热力图库 -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // 全局变量
        let map;
        let markers = [];
        let vehicleMarker = null;
        let deliveryPath = null;
        let destinationMarker = null;
        let currentProduct = null;
        let isDeliveryActive = false;
        let routePoints = [];
        let heatmapLayer = null;
        let heatmapVisible = false;
        let currentMapLayer = 'osm';
        let currentProvince = 'all';
        let allProductsData = [];
        let selectedProductForDelivery = null;
        let selectedMarker = null;
        let activeDeliveryCount = 0;
        let productTypeMapping = {};
        let allProductTypes = [];
        let deliveryQuantity = 1;
        let currentProductType = 'all'; // 新增：当前选中的产品类型
        let currentSearchKeyword = ''; // 新增：当前搜索关键词
        let currentSelectedProductId = null; // 新增：当前选中产品的ID

        // 江苏海洋大学坐标
        const DESTINATION = [34.6090, 119.2115];

        // 产品类型颜色映射
        const defaultProductTypeColorMapping = {
            '产地直销店': 'direct',
            '加工厂': 'factory',
            '水产码头': 'harbor',
            '果蔬基地': 'base',
            '粮食基地': 'grain'
        };

        // 地图图层定义
        const mapLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18,
                name: '标准地图'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 18,
                name: '卫星地图'
            })
        };

        // 页面初始化
        $(document).ready(function () {
            initMap();
            bindEvents();
            updateRealTimeClock();
            setInterval(updateRealTimeClock, 1000);
            loadAllProducts();

            // 新增：检查是否有从产品页面跳转过来的选中产品
            setTimeout(function () {
                const savedProduct = sessionStorage.getItem('selectedProduct');
                if (savedProduct) {
                    try {
                        const product = JSON.parse(savedProduct);
                        // 确保地图和产品数据已加载
                        if (map && allProductsData.length > 0) {
                            // 在地图中找到对应的产品
                            const foundProduct = allProductsData.find(p => p.product_id == product.id);
                            if (foundProduct) {
                                // 延迟执行以确保标记已加载
                                setTimeout(function () {
                                    selectProductByMarker(foundProduct);
                                    // 定位到该产品位置
                                    map.setView([foundProduct.origin_lat, foundProduct.origin_lng], 8);
                                    // 显示提示
                                    showNotification(`已定位到产品：${foundProduct.product_name}`, 'success');
                                }, 1000);
                            }
                        }
                        // 清除存储的产品信息，避免重复定位
                        sessionStorage.removeItem('selectedProduct');
                    } catch (e) {
                        console.error('解析产品信息失败:', e);
                    }
                }
            }, 1500);
        });

        // 新增：显示通知的函数
        function showNotification(message, type) {
            // 创建一个临时通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                            position: fixed;
                            top: 100px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: ${type === 'success' ? '#4CAF50' : '#FF5722'};
                            color: white;
                            padding: 12px 24px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            z-index: 2000;
                            font-weight: 600;
                            animation: slideDown 0.3s ease;
                        `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 新增CSS动画
        const style = document.createElement('style');
        style.textContent = `
                        @keyframes slideDown {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -20px);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, 0);
                            }
                        }
                        @keyframes slideUp {
                            from {
                                opacity: 1;
                                transform: translate(-50%, 0);
                            }
                            to {
                                opacity: 0;
                                transform: translate(-50%, -20px);
                            }
                        }
                    `;
        document.head.appendChild(style);

        function updateRealTimeClock() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const timeString = now.toLocaleString('zh-CN', options);
            $('#currentTime').text(timeString);
        }

        function initMap() {
            map = L.map('map').setView([35.8617, 104.1954], 5);
            mapLayers.osm.addTo(map);

            // 添加目的地标记
            destinationMarker = L.marker(DESTINATION, {
                icon: L.divIcon({
                    className: 'destination-marker-icon',
                    html: '<div class="destination-marker"><i class="bi bi-building"></i></div>',
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 17.5]
                })
            }).addTo(map);

            destinationMarker.bindPopup(`
                                    <div style="font-weight: 600; color: #2196F3; font-size: 0.9rem;">
                                        <i class="bi bi-building"></i> 江苏海洋大学配送中心
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666;">
                                        全国配送目的地<br>
                                        连云港市海州区苍梧路59号<br>
                                        联系电话: 0518-88888888
                                    </div>
                                `);
        }

        function bindEvents() {
            // 搜索功能
            $('#searchBtn').click(searchProduct);
            $('#productSearch').keypress(function (e) {
                if (e.which === 13) searchProduct();
            });

            // 视图控制按钮
            $('#viewControlBtn').click(function () {
                showAllProducts();
                resetView();
            });

            // 热力图控制按钮
            $('#heatmapToggleBtn').click(function () {
                toggleHeatmap();
            });

            // 关闭成功面板按钮
            $('#closeSuccessPanelBtn').click(function () {
                $('#deliverySuccessPanel').fadeOut(300);
            });

            // 地图图层切换
            $('[data-layer]').click(function () {
                const layer = $(this).data('layer');
                switchMapLayer(layer);
                $('[data-layer]').removeClass('active');
                $(this).addClass('active');
            });

            // 产品类型筛选
            $(document).on('click', '[data-type]', function () {
                const type = $(this).data('type');
                $('[data-type]').removeClass('active');
                $(this).addClass('active');
                currentProductType = type;
                applyAllFilters(); // 修改：应用所有筛选条件
            });

            // 省份筛选
            $('#provinceSelect').change(function () {
                currentProvince = $(this).val();
                applyAllFilters(); // 修改：应用所有筛选条件
            });

            // 配送按钮
            $('#startDeliveryBtn').click(function () {
                if (selectedProductForDelivery) {
                    startDeliveryAnimation();
                }
            });

            // 数量控制按钮
            $('#decreaseBtn').click(function () {
                let current = parseInt($('#deliveryQuantity').val());
                if (current > 1) {
                    $('#deliveryQuantity').val(current - 1);
                    deliveryQuantity = current - 1;
                }
            });

            $('#increaseBtn').click(function () {
                let current = parseInt($('#deliveryQuantity').val());
                let maxQty = parseInt($('#maxQuantity').text());
                if (current < maxQty) {
                    $('#deliveryQuantity').val(current + 1);
                    deliveryQuantity = current + 1;
                }
            });

            $('#deliveryQuantity').on('change', function () {
                let value = parseInt($(this).val());
                let maxQty = parseInt($('#maxQuantity').text());
                if (isNaN(value) || value < 1) {
                    $(this).val(1);
                    deliveryQuantity = 1;
                } else if (value > maxQty) {
                    $(this).val(maxQty);
                    deliveryQuantity = maxQty;
                } else {
                    deliveryQuantity = value;
                }
            });
        }

        // 显示全部产品
        function showAllProducts() {
            currentProvince = 'all';
            currentProductType = 'all';
            currentSearchKeyword = '';
            $('#provinceSelect').val('all');
            $('#productSearch').val('');
            $('[data-type]').removeClass('active');
            $('[data-type="all"]').addClass('active');

            addOriginMarkers(allProductsData);
            updateStatistics();

            if (heatmapVisible) {
                updateHeatmapData();
            }
        }

        // 重置视图
        function resetView() {
            map.setView([35.8617, 104.1954], 5);
        }

        // 从后端加载产品数据
        function loadAllProducts() {
            $.ajax({
                url: 'Handler1.ashx?action=getAllProducts',
                type: 'GET',
                dataType: 'json',
                success: function (products) {
                    if (products && products.length > 0) {
                        allProductsData = products;

                        // 过滤掉"水果基地"类型的数据
                        allProductsData = allProductsData.filter(product =>
                            !product.origin_type || product.origin_type !== '水果基地'
                        );

                        extractProductTypes(allProductsData);
                        generateProductTypeFilters();
                        loadProvinces();
                        addOriginMarkers(allProductsData);
                        updateStatistics();
                        updateDataUpdateTime();

                        // 初始化热力图数据（但先不显示）
                        initHeatmapData();

                        $('#systemStatus').removeClass('bg-warning').addClass('bg-success').text('在线');
                    } else {
                        console.warn('产品数据为空');
                        $('#systemStatus').removeClass('bg-success').addClass('bg-warning').text('无数据');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('加载产品数据失败:', error);
                    $('#systemStatus').removeClass('bg-success').addClass('bg-danger').text('连接失败');

                    // 显示空数据状态
                    allProductsData = [];
                    extractProductTypes(allProductsData);
                    generateProductTypeFilters();
                    loadProvinces();
                    updateStatistics();
                    updateDataUpdateTime();
                }
            });
        }

        // 提取所有产品类型
        function extractProductTypes(products) {
            const typeSet = new Set();
            productTypeMapping = {};

            // 首先确保包含所有新定义的类型
            Object.keys(defaultProductTypeColorMapping).forEach(type => {
                typeSet.add(type);
            });

            // 然后从数据中提取类型（过滤掉"水果基地"）
            products.forEach(product => {
                if (product.origin_type && product.origin_type !== '水果基地') {
                    typeSet.add(product.origin_type);

                    if (!productTypeMapping[product.origin_type]) {
                        const colorKey = defaultProductTypeColorMapping[product.origin_type] ||
                            getDefaultColorForType(product.origin_type);
                        productTypeMapping[product.origin_type] = colorKey;
                    }
                }
            });

            allProductTypes = Array.from(typeSet);
        }

        // 为产品类型获取默认颜色
        function getDefaultColorForType(type) {
            const colorKeys = Object.keys(defaultProductTypeColorMapping);

            for (const key in defaultProductTypeColorMapping) {
                if (type.includes(key)) {
                    return defaultProductTypeColorMapping[key];
                }
            }

            const colors = ['direct', 'factory', 'harbor', 'base', 'grain', 'other'];
            const index = type.length % colors.length;
            return colors[index];
        }

        // 生成产品类型筛选按钮
        function generateProductTypeFilters() {
            const container = $('#productTypeFilters');
            container.empty();

            container.append(`
                                    <button class="filter-btn active" data-type="all">全部</button>
                                `);

            allProductTypes.forEach(type => {
                if (type !== '水果基地') {
                    container.append(`
                                            <button class="filter-btn" data-type="${type}">${type}</button>
                                        `);
                }
            });
        }

        // 根据产品类型获取颜色类名
        function getProductColorClass(productType) {
            if (!productType || productType === '水果基地') return 'color-other';
            return `color-${productTypeMapping[productType] || 'other'}`;
        }

        // 更新数据更新时间
        function updateDataUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
            $('#dataUpdateTime').text(timeString);
        }

        // 新增：应用所有筛选条件
        function applyAllFilters() {
            let filteredData = allProductsData;

            // 应用省份筛选
            if (currentProvince !== 'all') {
                filteredData = filteredData.filter(product => product.province === currentProvince);
            }

            // 应用产品类型筛选
            if (currentProductType !== 'all') {
                filteredData = filteredData.filter(product => product.origin_type === currentProductType);
            }

            // 应用搜索筛选
            if (currentSearchKeyword) {
                filteredData = filteredData.filter(product =>
                    (product.product_name && product.product_name.toLowerCase().includes(currentSearchKeyword)) ||
                    (product.origin_name && product.origin_name.toLowerCase().includes(currentSearchKeyword)) ||
                    (product.province && product.province.toLowerCase().includes(currentSearchKeyword))
                );
            }

            // 显示筛选后的数据
            addOriginMarkers(filteredData);

            if (heatmapVisible) {
                updateHeatmapData();
            }
        }

        function addOriginMarkers(products) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!Array.isArray(products) || products.length === 0) {
                console.log('没有产品数据可以显示');
                updateStatistics();
                // 如果没有产品显示，清除配送路线
                if (deliveryPath) {
                    map.removeLayer(deliveryPath);
                    deliveryPath = null;
                }
                // 隐藏当前产品信息
                $('#currentProductSection').hide();
                selectedProductForDelivery = null;
                currentSelectedProductId = null;
                return;
            }

            products.forEach(product => {
                // 跳过"水果基地"类型的产品
                if (product.origin_type === '水果基地') return;

                if (!product.origin_lat || !product.origin_lng) return;

                const colorClass = getProductColorClass(product.origin_type);

                const markerIcon = L.divIcon({
                    className: 'product-dot-icon',
                    html: `<div class="product-dot ${colorClass}"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([product.origin_lat, product.origin_lng], {
                    icon: markerIcon,
                    title: product.product_name
                }).addTo(map);

                marker.on('click', function () {
                    selectProductByMarker(product);
                });

                marker.productData = product;
                markers.push(marker);
            });

            console.log(`添加了 ${markers.length} 个标记点`);

            // 检查当前选中的产品是否还在显示的产品中
            if (currentSelectedProductId) {
                const markerExists = markers.some(marker =>
                    marker.productData.product_id === currentSelectedProductId
                );

                if (markerExists) {
                    // 如果选中产品还在，重新选中它
                    const product = products.find(p => p.product_id === currentSelectedProductId);
                    if (product) {
                        // 延迟一小段时间确保标记已添加到地图
                        setTimeout(() => {
                            selectProductByMarker(product);
                        }, 50);
                    }
                } else {
                    // 如果选中产品不在显示的产品中，清除配送路线
                    if (deliveryPath) {
                        map.removeLayer(deliveryPath);
                        deliveryPath = null;
                    }
                    // 隐藏当前产品信息
                    $('#currentProductSection').hide();
                    selectedProductForDelivery = null;
                    currentSelectedProductId = null;
                }
            }

            updateStatistics();
        }

        function selectProductByMarker(product) {
            // 保存当前选中产品的ID
            currentSelectedProductId = product.product_id;

            // 取消之前选中的标记
            if (selectedMarker) {
                const prevColorClass = getProductColorClass(selectedMarker.productData.origin_type);
                const prevIcon = L.divIcon({
                    className: 'product-dot-icon',
                    html: `<div class="product-dot ${prevColorClass}"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                selectedMarker.setIcon(prevIcon);
            }

            // 查找并选中当前标记
            selectedMarker = markers.find(m => m.productData.product_id === product.product_id);
            if (selectedMarker) {
                const colorClass = getProductColorClass(product.origin_type);
                const selectedIcon = L.divIcon({
                    className: 'product-dot-icon',
                    html: `<div class="product-dot ${colorClass} selected"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                selectedMarker.setIcon(selectedIcon);
            }

            currentProduct = product;
            selectedProductForDelivery = product;
            updateProductInfo(product);
            calculateDeliveryRoute(product.origin_lat, product.origin_lng);

            // 更新数量选择器
            if (product.stock) {
                $('#maxQuantity').text(product.stock);
                $('#deliveryQuantity').val(1);
                $('#deliveryQuantity').attr('max', product.stock);
                $('#quantitySelector').show();
                deliveryQuantity = 1;
            } else {
                $('#quantitySelector').hide();
            }
        }

        function updateProductInfo(product) {
            const colorClass = getProductColorClass(product.origin_type);

            const html = `
                                    <div class="product-card">
                                        <div class="product-header">
                                            <div class="product-name">
                                                <div class="product-dot ${colorClass}" style="width: 14px; height: 14px;"></div>
                                                ${product.product_name}
                                            </div>
                                            ${product.price ? `<div class="product-price">¥${product.price}</div>` : ''}
                                        </div>
                                        <div class="product-details">
                                            ${product.origin_name ? `<div class="detail-item">
                                                <span class="detail-label">产地：</span>${product.origin_name}
                                            </div>` : ''}
                                            ${product.province ? `<div class="detail-item">
                                                <span class="detail-label">省份：</span>${product.province}
                                            </div>` : ''}
                                            ${product.origin_type ? `<div class="detail-item">
                                                <span class="detail-label">类型：</span>${product.origin_type}
                                            </div>` : ''}
                                            ${product.stock ? `<div class="detail-item">
                                                <span class="detail-label">库存：</span>${product.stock}${product.unit || '斤'}
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `;

            $('#currentProductCard').html(html);
            $('#currentProductSection').show();
        }

        function calculateDeliveryRoute(startLat, startLng, endLat, endLng) {
            // 先移除现有的配送路线
            if (deliveryPath) {
                map.removeLayer(deliveryPath);
                deliveryPath = null;
            }

            // 生成新的路线点
            routePoints = generateCurvedRoute(startLat, startLng, DESTINATION[0], DESTINATION[1]);

            // 创建新的配送路线
            deliveryPath = L.polyline(routePoints, {
                color: '#9C27B0',
                weight: 4,
                opacity: 0.8,
                lineCap: 'round',
                dashArray: '10, 10',
                className: 'route-path'
            }).addTo(map);
        }

        function generateCurvedRoute(startLat, startLng, endLat, endLng) {
            const points = [[startLat, startLng]];
            const midLat = (startLat + endLat) / 2;
            const midLng = (startLng + endLng) / 2;

            const controlLat = midLat + (Math.random() - 0.5) * 2;
            const controlLng = midLng + (Math.random() - 0.5) * 2;

            for (let i = 0; i <= 10; i++) {
                const t = i / 10;
                const lat = (1 - t) * (1 - t) * startLat + 2 * (1 - t) * t * controlLat + t * t * endLat;
                const lng = (1 - t) * (1 - t) * startLng + 2 * (1 - t) * t * controlLng + t * t * endLng;
                points.push([lat, lng]);
            }

            points.push([endLat, endLng]);
            return points;
        }

        function startDeliveryAnimation() {
            if (isDeliveryActive || !selectedProductForDelivery) {
                return;
            }

            // 检查库存
            if (selectedProductForDelivery.stock && deliveryQuantity > selectedProductForDelivery.stock) {
                alert(`库存不足！当前库存: ${selectedProductForDelivery.stock}${selectedProductForDelivery.unit || '斤'}`);
                return;
            }

            isDeliveryActive = true;
            activeDeliveryCount++;
            updateStatistics();

            $('#progressContainer').show();
            $('#deliveryTitle').text(`配送中：${selectedProductForDelivery.product_name} (${deliveryQuantity}${selectedProductForDelivery.unit || '斤'})`);

            addVehicleMarker(selectedProductForDelivery.origin_lat, selectedProductForDelivery.origin_lng);
            animateDelivery();
        }

        function addVehicleMarker(lat, lng) {
            if (vehicleMarker) map.removeLayer(vehicleMarker);

            vehicleMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'vehicle-marker-icon',
                    html: '<div class="vehicle-marker"><i class="bi bi-truck"></i></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
        }

        function animateDelivery() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += 1;
                $('#deliveryProgress').css('width', progress + '%');

                if (progress <= 20) {
                    $('#deliveryStatus').text('正在准备商品...');
                } else if (progress <= 50) {
                    $('#deliveryStatus').text('正在装车配送...');
                } else if (progress <= 80) {
                    $('#deliveryStatus').text('运输途中...');
                } else if (progress < 100) {
                    $('#deliveryStatus').text('即将到达...');
                } else {
                    $('#deliveryStatus').html('<span style="color: #4CAF50; font-weight: 600;">配送完成！</span>');
                    clearInterval(interval);

                    // 显示配送成功面板
                    showDeliverySuccessPanel();

                    setTimeout(() => {
                        $('#progressContainer').hide();
                        if (vehicleMarker) map.removeLayer(vehicleMarker);
                        isDeliveryActive = false;
                        activeDeliveryCount--;
                        updateStatistics();
                    }, 2000);
                }

                if (vehicleMarker && routePoints.length > 0) {
                    const segmentProgress = (progress / 100) * (routePoints.length - 1);
                    const segmentIndex = Math.floor(segmentProgress);
                    const segmentFraction = segmentProgress - segmentIndex;

                    if (segmentIndex < routePoints.length - 1) {
                        const pointA = routePoints[segmentIndex];
                        const pointB = routePoints[segmentIndex + 1];
                        const currentLat = pointA[0] + (pointB[0] - pointA[0]) * segmentFraction;
                        const currentLng = pointA[1] + (pointB[1] - pointA[1]) * segmentFraction;
                        vehicleMarker.setLatLng([currentLat, currentLng]);
                    }
                }
            }, 50);
        }

        // 显示配送成功面板
        function showDeliverySuccessPanel() {
            if (!selectedProductForDelivery) return;

            const product = selectedProductForDelivery;
            const now = new Date();
            const deliveryTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            const totalPrice = product.price ? (product.price * deliveryQuantity).toFixed(2) : '0.00';

            const detailsHtml = `
                                    <div class="detail-row">
                                        <span class="detail-label">产品名称：</span>
                                        <span class="detail-value">${product.product_name || '未命名产品'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">产地：</span>
                                        <span class="detail-value">${product.origin_name || '未知产地'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">配送数量：</span>
                                        <span class="detail-value">${deliveryQuantity}${product.unit || '斤'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">配送目的地：</span>
                                        <span class="detail-value">江苏海洋大学</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">配送时间：</span>
                                        <span class="detail-value">${deliveryTime}</span>
                                    </div>
                                    ${product.price ? `<div class="detail-row">
                                        <span class="detail-label">总金额：</span>
                                        <span class="detail-value">¥${totalPrice}</span>
                                    </div>` : ''}
                                `;

            $('#successDetails').html(detailsHtml);
            $('#deliverySuccessPanel').fadeIn(300);
        }

        function searchProduct() {
            const keyword = $('#productSearch').val().trim().toLowerCase();
            currentSearchKeyword = keyword;

            if (!keyword) {
                // 如果没有搜索关键词，应用其他筛选条件
                applyAllFilters();
                return;
            }

            applyAllFilters(); // 应用所有筛选条件（包括搜索）
        }

        function switchMapLayer(layer) {
            if (currentMapLayer === layer) return;
            mapLayers[currentMapLayer].remove();
            mapLayers[layer].addTo(map);
            currentMapLayer = layer;
        }

        // 初始化热力图数据
        function initHeatmapData() {
            // 确保有数据
            if (allProductsData.length === 0) {
                console.log('没有数据用于热力图');
                return;
            }

            // 移除现有的热力图
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }

            // 生成热力图数据
            const heatData = allProductsData
                .filter(product => product.origin_lat && product.origin_lng && product.origin_type !== '水果基地')
                .map(product => {
                    // 根据库存计算权重
                    let weight = 0.5; // 默认权重
                    if (product.stock) {
                        // 将库存映射到0.1-1.0的范围
                        weight = Math.min(1.0, Math.max(0.1, (product.stock / 10000) * 1.0));
                    }
                    return [product.origin_lat, product.origin_lng, weight];
                });

            if (heatData.length === 0) {
                console.log('没有有效的热力图数据点');
                return;
            }

            // 创建热力图
            heatmapLayer = L.heatLayer(heatData, {
                radius: 35,           // 热力点半径
                blur: 20,             // 模糊度
                maxZoom: 17,
                max: 1.0,
                minOpacity: 0.6,      // 最小透明度
                gradient: {
                    0.0: 'blue',
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'
                }
            });

            console.log(`创建了热力图，包含 ${heatData.length} 个数据点`);

            // 初始状态不显示热力图
            heatmapVisible = false;
            $('#heatmapToggleBtn').html('<i class="bi bi-fire"></i> 热力图开关');
            $('#heatmapLegend').hide();
        }

        // 更新热力图数据
        function updateHeatmapData() {
            // 移除现有的热力图
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }

            if (!heatmapVisible || markers.length === 0) {
                return;
            }

            // 获取当前可见的标记点
            const visibleMarkers = markers.filter(marker => map.hasLayer(marker));

            if (visibleMarkers.length === 0) {
                return;
            }

            // 生成热力图数据
            const heatData = visibleMarkers.map(marker => {
                const product = marker.productData;
                let weight = 0.5;
                if (product.stock) {
                    weight = Math.min(1.0, Math.max(0.1, (product.stock / 10000) * 1.0));
                }
                return [product.origin_lat, product.origin_lng, weight];
            });

            // 重新创建热力图
            heatmapLayer = L.heatLayer(heatData, {
                radius: 35,
                blur: 20,
                maxZoom: 17,
                max: 1.0,
                minOpacity: 0.6,
                gradient: {
                    0.0: 'blue',
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'
                }
            }).addTo(map);
        }

        // 切换热力图显示
        function toggleHeatmap() {
            heatmapVisible = !heatmapVisible;

            if (heatmapVisible) {
                // 显示热力图
                if (heatmapLayer) {
                    heatmapLayer.addTo(map);
                } else {
                    // 如果没有热力图数据，重新初始化
                    initHeatmapData();
                    if (heatmapLayer) {
                        heatmapLayer.addTo(map);
                    }
                }
                $('#heatmapToggleBtn').html('<i class="bi bi-fire me-2"></i> 隐藏热力图');
                $('#heatmapLegend').show();
                console.log('热力图已显示');
            } else {
                // 隐藏热力图
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                $('#heatmapToggleBtn').html('<i class="bi bi-fire"></i> 热力图开关');
                $('#heatmapLegend').hide();
                console.log('热力图已隐藏');
            }
        }

        function loadProvinces() {
            const provinces = [...new Set(allProductsData
                .map(p => p.province)
                .filter(Boolean)
                .sort())];

            const select = $('#provinceSelect');
            select.empty();
            select.append('<option value="all">全部省份</option>');

            if (provinces.length > 0) {
                provinces.forEach(province => {
                    select.append(`<option value="${province}">${province}</option>`);
                });
            }
        }

        function updateStatistics() {
            // 获取当前可见的标记点
            const visibleMarkers = markers.filter(marker => map.hasLayer(marker));
            const visibleProducts = visibleMarkers.length;

            // 获取当前可见产品的省份和类型
            const visibleProvinces = [...new Set(visibleMarkers
                .map(marker => marker.productData.province)
                .filter(Boolean))].length;

            const visibleProductTypes = [...new Set(visibleMarkers
                .map(marker => marker.productData.origin_type)
                .filter(Boolean))].length;

            // 更新统计数据显示
            $('#visibleProducts').text(visibleProducts);
            $('#visibleProvinces').text(visibleProvinces);
            $('#visibleProductTypes').text(visibleProductTypes);
            $('#activeDeliveries').text(activeDeliveryCount);

            console.log(`更新统计数据: 显示产品=${visibleProducts}, 显示省份=${visibleProvinces}, 显示类型=${visibleProductTypes}`);
        }
    </script>
</body>
</html>